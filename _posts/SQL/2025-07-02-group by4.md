---
layout: post
title:  "[SQL] LV.3 대여 횟수가 많은 자동차들의 월별 대여 횟수 구하기(GROUP BY)" 
subtitle: programmers
tags: [MySQL]
categories: SQL
---
<img width="100%" alt="Image" src="https://github.com/user-attachments/assets/576a3402-5d36-4141-8911-03a2e9c1a015" />

# 문제
<https://school.programmers.co.kr/learn/courses/30/lessons/151139>

## 테이블 구조

1. `CAR_RENTAL_COMPANY_RENTAL_HISTORY`테이블
    - `HISTORY_ID`: 자동차 대여 기록 ID
    - `CAR_ID`: 자동차 ID
    - `START_DATE`: 대여 시작일
    - `END_DATE`: 대여 종료일

## 답안


```sql
SELECT MONTH(START_DATE) AS MONTH, CAR_ID, COUNT(*) AS RECORDS
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
WHERE DATE_FORMAT(START_DATE, '%Y-%m') BETWEEN '2022-08' AND '2022-10' 
    AND CAR_ID IN (SELECT CAR_ID
                   FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
                   WHERE DATE_FORMAT(START_DATE, '%Y-%m') BETWEEN '2022-08' AND '2022-10'
                   GROUP BY CAR_ID
                   HAVING COUNT(CAR_ID) >= 5)
GROUP BY CAR_ID, MONTH(START_DATE)
HAVING RECORDS >= 1
ORDER BY MONTH, CAR_ID DESC
```

## 쿼리 설명

### 1. 서브쿼리


```sql
IN (SELECT CAR_ID
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
    WHERE DATE_FORMAT(START_DATE, '%Y-%m') BETWEEN '2022-08' AND '2022-10'
    GROUP BY CAR_ID
    HAVING COUNT(CAR_ID) >= 5)
```

- 2022년 8 ~ 10월 사이에
- `CAR_ID`별로 그룹화
- 해당 기간 동안 5회 이상 대여된 차량 ID만 추출

### 2. 메인쿼리


```sql
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
WHERE DATE_FORMAT(START_DATE, '%Y-%m') BETWEEN '2022-08' AND '2022-10' 
    AND CAR_ID IN(...)
```

- 위 서브쿼리에서 나온 **5회 이상 대여된 차량**만 선택
- 그 중에서도 2022년 8 ~ 10월 사이의 대여 기록만 필터링
