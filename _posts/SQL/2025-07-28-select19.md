---
layout: post
title:  "[SQL] LV.3 대장균들의 크기에 따라 분류하기 2(SELECT)" 
subtitle: programmers
tags: [Oracle]
categories: SQL
---
<img width="100%" alt="Image" src="https://github.com/user-attachments/assets/576a3402-5d36-4141-8911-03a2e9c1a015" />

# 문제
<https://school.programmers.co.kr/learn/courses/30/lessons/301649>

## 테이블 구조

1. `ECOLI_DATA`테이블
    - `ID`: 대장균 개체의 ID
    - `PARENT_ID`: 부모 개체의 ID
    - `SIZE_OF_COLONY`: 개체의 크기
    - `DIFFERENTIATION_DATA`: 분화되어 나온 날짜
    - `GENOTYPE`: 개체의 형질

## 1. 답안


```sql
SELECT 
    D.ID, 
    CASE
        WHEN D.R > D.MAX_ID * 0.75 THEN 'CRITICAL'
        WHEN D.R > D.MAX_ID * 0.5 THEN 'HIGH'
        WHEN D.R > D.MAX_ID * 0.25 THEN 'MEDIUM'
        ELSE 'LOW'
    END AS COLONY_NAME
FROM (
    SELECT 
        ID,
        ROW_NUMBER() OVER (ORDER BY SIZE_OF_COLONY) AS R,
        MAX(ID) OVER() AS MAX_ID
    FROM ECOLI_DATA
) AS D
ORDER BY D.ID
```

## 쿼리 설명

### 1. 내부 서브쿼리: 순위와 기준 계산


```sql
SELECT 
        ID,
        ROW_NUMBER() OVER (ORDER BY SIZE_OF_COLONY) AS R,
        MAX(ID) OVER() AS MAX_ID
    FROM ECOLI_DATA
```

- `ROW_NUMBER() OVER (ORDER BY SIZE_OF_COLONY) AS R`
    + `SIZE_OF_COLY`를 기준으로 오름차순으로 정렬 후, 각 행에 1부터 시작하는 고유 순서 번호를 부여한다.
    + 가장 작은 colony는 R = 1, 가장 큰 colony는 R = 최댓값
- `MAX(ID) OVER() AS MAX_ID`
    + 전체 데이터에서 `ID`의 최댓값을 모든 행에 동일하게 표시한다.

### 2. 외부 서브쿼리: COLONY_NAME 분류


```sql
CASE
        WHEN D.R > D.MAX_ID * 0.75 THEN 'CRITICAL'
        WHEN D.R > D.MAX_ID * 0.5 THEN 'HIGH'
        WHEN D.R > D.MAX_ID * 0.25 THEN 'MEDIUM'
        ELSE 'LOW'
    END AS COLONY_NAME
```

- 각 개체의 순위 R이 `MAX_ID`의 몇 % 이상인지에 따라 분류:
    + 상위 75% 초과 → 'CRITICAL'
    + 상위 50% 초과 → 'HIGH'
    + 상위 25% 초과 → 'MEDIUM'
    + 그 외 → 'LOW'

## 2. 답안


```sql
SELECT 
    D.ID, 
    CASE
        WHEN D.R >= 0.75 THEN 'CRITICAL'
        WHEN D.R >= 0.5 THEN 'HIGH'
        WHEN D.R >= 0.25 THEN 'MEDIUM'
        ELSE 'LOW'
    END AS COLONY_NAME
FROM (
    SELECT 
        ID,
        PERCENT_RANK() OVER (ORDER BY SIZE_OF_COLONY) AS R
    FROM ECOLI_DATA
) AS D
ORDER BY D.ID
```

## 쿼리 설명

### 1. 내부 서브쿼리


```sql
SELECT 
    ID,
    PERCENT_RANK() OVER (ORDER BY SIZE_OF_COLONY) AS R
FROM ECOLI_DATA
```

- `PERCENT_RANK()` 함수란?
    + 0부터 1 사이의 상대적인 순위를 부여하는 윈도우 함수이다.
    + 공식 : (현재 행의 순위 - 1) / (전체 행 개수 - 1)
- 가장 작은 colony는 `R = 0.0`, 가장 큰 colony는 `R = 1.0`에 가까워진다. 

### 2. 외부 서브쿼리: COLONY_NAME 분류


```sql
CASE
    WHEN R >= 0.75 THEN 'CRITICAL'
    WHEN R >= 0.5 THEN 'HIGH'
    WHEN R >= 0.25 THEN 'MEDIUM'
    ELSE 'LOW'
END AS COLONY_NAME
```

- `PERCENT_RANK`값 `R`을 기준으로 COLONY_NAME을 분류한다.
    + `R >= 0.75` : 상위 25%
    + `R >= 0.5` : 상위 25% ~ 50%
    + `R >= 0.25` : 상위 50% ~ 75%
    + 그 외 : 하위 25%
