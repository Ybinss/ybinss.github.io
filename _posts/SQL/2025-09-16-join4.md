---
layout: post
title:  "[SQL] LV.4 특정 기간동안 대여 가능한 자동차들의 대여비용 구하기(JOIN)" 
subtitle: programmers
tags: [MYSQL]
categories: SQL
---
<img width="100%" alt="Image" src="https://github.com/user-attachments/assets/576a3402-5d36-4141-8911-03a2e9c1a015" />

# 문제
<https://school.programmers.co.kr/learn/courses/30/lessons/157339>

## 테이블 구조

1. `CAR_RENTAL_COMPANY_CAR`테이블
    - `CAR_ID`: 자동차 ID
    - `CAR_TYPE`: 자동차 종류
    - `DAILY_FEE`: 일일 대여 요금(원)
    - `OPTIONS`: 자동차 옵션 리스트
2. `CAR_RENTAL_COMPANY_RENTAL_HISTORY`테이블
    - `HISTORY_ID`: 자동차 대여 기록 ID
    - `CAR_ID`: 자동차 ID
    - `START_DATE`: 대여 시작일
    - `END_DATE`: 대여 종료일
3. `CAR_RENTAL_COMPANY_DISCOUNT_PLAN`테이블
    - `PLAN_ID`: 요금 할인 정책 ID
    - `CAR_TYPE`: 자동차 종류
    - `DURATION_TYPE`: 대여 기간 종류
    - `DISCOUNT_RATE`: 할인율(%)

## 답안


```sql
SELECT CAR_ID, CAR_TYPE, FEE
FROM (
  SELECT
    C.CAR_ID,
    C.CAR_TYPE,
    ROUND(C.DAILY_FEE * 30 * (100 - P.DISCOUNT_RATE) / 100) AS FEE
  FROM CAR_RENTAL_COMPANY_CAR C
  JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN P
    ON C.CAR_TYPE = P.CAR_TYPE
  WHERE C.CAR_TYPE IN ('세단', 'SUV')
    AND P.DURATION_TYPE = '30일 이상'
    AND NOT EXISTS (
      SELECT 1
      FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
      WHERE H.CAR_ID = C.CAR_ID
        AND H.END_DATE > '2022-11-01'
        AND H.START_DATE < '2022-12-01'
    )
) T
WHERE FEE >= 500000 AND FEE < 2000000
ORDER BY FEE DESC, CAR_TYPE, CAR_ID DESC;
```

## 쿼리 설명


```sql
 ROUND(C.DAILY_FEE * 30 * (100 - P.DISCOUNT_RATE) / 100) AS FEE
```

- `FEE`: 30일 요금(할인 적용)
    + 기본: `C.DAILY_FEE * 30`
    + 할인 적용: `* (100 - 할인율) / 100`
    + `ROUND(...)`: 반올림 


```sql
AND NOT EXISTS (
      SELECT 1
      FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
      WHERE H.CAR_ID = C.CAR_ID
        AND H.END_DATE > '2022-11-01'
        AND H.START_DATE < '2022-12-01'
    )
```

- 해당 기간에 예약/대여가 겹치는 이력이 하나라도 있으면 제외
