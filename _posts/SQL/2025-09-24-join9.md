---
layout: post
title:  "[SQL] LV.4 자동차 대여 기록 별 대여 금액 구하기(JOIN)" 
subtitle: programmers
tags: [MySQL]
categories: SQL
---
<img width="100%" alt="Image" src="https://github.com/user-attachments/assets/576a3402-5d36-4141-8911-03a2e9c1a015" />

# 문제
<https://school.programmers.co.kr/learn/courses/30/lessons/151141>

## 테이블 구조

1. `CAR_RENTAL_COMPANY_CAR`테이블
    - `CAR_ID`: 자동차 ID
    - `CAR_TYPE`: 자동차 종류
    - `DAILY_FEE`: 일일 대여 요금(원)
    - `OPTIONS`: 자동차 옵션 리스트
1. `CAR_RENTAL_COMPANY_RENTAL_HISTORY`테이블
    - `HISTORY_ID`: 자동차 대여 기록 ID
    - `CAR_ID`: 자동차 ID
    - `START_DATE`: 대여 시작일
    - `END_DATE`: 대여 종료일
1. `CAR_RENTAL_COMPANY_DISCOUNT_PLAN`테이블
    - `PLAN_ID`: 요금 할인 정책 ID
    - `CAR_TYPE`: 자동차 종류
    - `DURATION_TYPE`: 대여 기간 종류
    - `DISCOUNT_RATE`: 할인율(%)

## 답안


```sql
WITH A AS (
    SELECT
        C.DAILY_FEE,
        C.CAR_TYPE,
        H.HISTORY_ID,
        DATEDIFF(END_DATE, START_DATE) + 1 AS PERIOD,
    CASE
        WHEN DATEDIFF(END_DATE, START_DATE) + 1 >= 90 THEN '90일 이상'
        WHEN DATEDIFF(END_DATE, START_DATE) + 1 BETWEEN 30 AND 89 THEN '30일 이상'
        WHEN DATEDIFF(END_DATE, START_DATE) + 1 BETWEEN 7 AND 29 THEN '7일 이상'
        ELSE 'NONE'
    END AS DURATION_TYPE
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
JOIN CAR_RENTAL_COMPANY_CAR C ON C.CAR_ID = H.CAR_ID
WHERE C.CAR_TYPE = '트럭')

SELECT
    A.HISTORY_ID,
    ROUND(A.DAILY_FEE * A.PERIOD * (100 - IFNULL(P.DISCOUNT_RATE, 0)) * 0.01) AS FEE
FROM A
LEFT JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN P 
    ON P.DURATION_TYPE = A.DURATION_TYPE
    AND P.CAR_TYPE = A.CAR_TYPE
ORDER BY FEE DESC, A.HISTORY_ID DESC
```

## 쿼리 설명

### WITH A (서브쿼리)


```sql
WITH A AS (
    SELECT
        C.DAILY_FEE,
        C.CAR_TYPE,
        H.HISTORY_ID,
        DATEDIFF(END_DATE, START_DATE) + 1 AS PERIOD,
    CASE
        WHEN DATEDIFF(END_DATE, START_DATE) + 1 >= 90 THEN '90일 이상'
        WHEN DATEDIFF(END_DATE, START_DATE) + 1 BETWEEN 30 AND 89 THEN '30일 이상'
        WHEN DATEDIFF(END_DATE, START_DATE) + 1 BETWEEN 7 AND 29 THEN '7일 이상'
        ELSE 'NONE'
    END AS DURATION_TYPE
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
JOIN CAR_RENTAL_COMPANY_CAR C ON C.CAR_ID = H.CAR_ID
WHERE C.CAR_TYPE = '트럭')
```

- `DATEDIFF(END_DATE, START_DATE) + 1`
    + MySQL의 `DATEDIFF`는 **종료일 - 시작일**의 일 수 차이만 계산하므로, **+1**을 해서 당일 포함한 실제 대여 일수로 계산
- `CASE ... END`를 이용해 대여 기간을 할인 구간(`DURATION_TYPE`)으로 분류

### 메인 SELECT


```sql
SELECT
    A.HISTORY_ID,
    ROUND(A.DAILY_FEE * A.PERIOD * (100 - IFNULL(P.DISCOUNT_RATE, 0)) * 0.01) AS FEE
FROM A
LEFT JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN P 
    ON P.DURATION_TYPE = A.DURATION_TYPE
    AND P.CAR_TYPE = A.CAR_TYPE
ORDER BY FEE DESC, A.HISTORY_ID DESC
```

- `LEFT JOIN`
    + 요금제 테이블(`P`)에 조인
    + 기준은 `CAR_TYPE = '트럭'` + 할인 대상 구간(`DURATION_TYPE`)
    + 대응 요금제가 없는 경우도 계산할 수 있도록 LEFT JOIN 사용
