---
layout: post
title:  "[SQL] LV.3 오랜 기간 보호한 동물(1)(JOIN)" 
subtitle: programmers
tags: [Oracle]
categories: SQL
---
<img width="100%" alt="Image" src="https://github.com/user-attachments/assets/576a3402-5d36-4141-8911-03a2e9c1a015" />

# 문제
<https://school.programmers.co.kr/learn/courses/30/lessons/59042>

## 테이블 구조

1. `ANMAL_INS`테이블
    - `ANIMAL_ID`: 동물의 아이디
    - `ANMIMAL_TYPE`: 생물 종
    - `DATETIME`: 보호 시작일
    - `INTAKE_CONDITION`: 보호 시작시 상태
    - `NAME`: 이름
    - `SEX_UPON_INTAKE`: 성별 및 중성화 여부
2. `ANMAL_OUTS`테이블
    - `ANIMAL_ID`: 동물의 아이디
    - `ANMIMAL_TYPE`: 생물 종
    - `DATETIME`: 보호 시작일
    - `NAME`: 이름
    - `SEX_UPON_INTAKE`: 성별 및 중성화 여부

## 1. 답안(ROWNUM)


```sql
SELECT *
FROM (SELECT AI.NAME, AI.DATETIME
      FROM ANIMAL_INS AI 
      LEFT JOIN ANIMAL_OUTS AO ON AI.ANIMAL_ID = AO.ANIMAL_ID
      WHERE AO.ANIMAL_ID IS NULL
      ORDER BY AI.DATETIME
     )
WHERE ROWNUM < 4;
```

**< 왜 서브쿼리로 감싸는가? >**

- Oracle에서 `ROWNUM`은 결과가 만들어지는 과정에서 번호가 매겨진다.
- 중요한 점:
    + `ROWNUM` 필터가 ORDER BY보다 먼저 적용되는 형태로 동작할 수 있어, 정렬 전에 잘라버리면 "정렬 기준 상위 3개"가 아니라 "무작위 3개"가 될 위험이 있다.
    + 그래서 먼저 정렬을 완료한 결과를 서브쿼리로 고정한 다음, 바깥에서 `ROWNUM < 4`로 상위 3개를 안전하게 자른다.

### 쿼리 설명


```sql
LEFT JOIN ANIMAL_OUTS AO ON AI.ANIMAL_ID = AO.ANIMAL_ID
```

- `AMIMAL_OUTS`테이블을 `AO`로 붙인다.
- `LEFT JOIN`
    + `ANIMAL_INS`에 있는 행은 무조건 유지
    + `ANIMAL_OUTS`에 매칭되는 `ANIMAL_ID`가 있으면 붙고,
    + 없으면 `AO.*`컬럼들이 NULL로 채워진다. 


```sql
WHERE AI.ANIMAL_ID IS NULL
```

- 입소 기록이 매칭되지 않은 행만 남긴다.


```sql
SELECT *
```

- 바깥에서 `SELECT *`를 했지만, 안쪽에서 `AI.NAME, AI.DATETIME`만 뽑았으므로 결과는 `NAME`, `DATETIME`만 뽑는다.

## 2. 답안(FETCH FIRST)


```sql
SELECT AI.NAME, AI.DATETIME
FROM ANIMAL_INS AI
LEFT JOIN ANIMAL_OUTS AO ON AI.ANIMAL_ID = AO.ANIMAL_ID
WHERE AO.ANIMAL_ID IS NULL
ORDER BY AI.DATETIME
FETCH FIRST 3 ROWS ONLY;
```

### 쿼리 설명


```sql
FETCH FIRST 3 ROWS ONLY;
```

- `ORDER BY`로 정렬된 결과에서 위에서부터 3행만 반환

## 3. 답안(NOT EXISTS)


```sql
SELECT AI.NAME, AI.DATETIME
FROM ANIMAL_INS AI
WHERE NOT EXISTS (
    SELECT 1
    FROM ANIMAL_OUTS AO
    WHERE AO.ANIMAL_ID = AI.ANIMAL_ID
)
ORDER BY AI.DATETIME
FETCH FIRST 3 ROWS ONLY;
```

### 쿼리 설명


```sql
WHERE NOT EXISTS(...)
```

- `ANIMAL_OUTS`에 같은 ANIMAL_ID가 존재하지 않는(`NOT EXISTS`) 입소기록만 남김
- 즉, 아직 퇴소 기록이 없는 동물만 조회
